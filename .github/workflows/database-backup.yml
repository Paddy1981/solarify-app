# =============================================================================
# Database Backup Workflow
# A workflow to trigger a database backup with a choice of environment.
# =============================================================================
name: ğŸ’¾ Database Backup

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'The deployment environment to back up.'
        required: false
        default: 'production' 
        type: choice
        options:
          - 'production'
          - 'staging'

env:
  PROJECT_ID: solarify-${{ github.event.inputs.environment }}

jobs:
  backup-database:
    name: ğŸ’¾ Backup Database
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ” Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}
          project_id: ${{ env.PROJECT_ID }}

      - name: ğŸ› ï¸ Setup Google Cloud CLI
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.PROJECT_ID }}

      - name: ğŸš€ Run Firestore backup
        id: firestore-backup
        run: |
          echo "Starting backup for Firestore database in ${{ github.event.inputs.environment }} environment..."
          gcloud firestore export gs://${{ env.PROJECT_ID }}-backups/backups/${{ github.event.inputs.environment }}/$(date +"%Y-%m-%d-%H-%M-%S")
          echo "âœ… Firestore backup completed successfully."

      - name: ğŸš€ Run Cloud SQL backup
        id: cloudsql-backup
        run: |
          echo "Starting backup for Cloud SQL instance in ${{ github.event.inputs.environment }} environment..."
          # Replace 'your-cloud-sql-instance' with your actual instance name
          gcloud sql backups create --instance=your-cloud-sql-instance --async
          echo "âœ… Cloud SQL backup initiated."
          
      - name: ğŸ“¢ Notify backup status
        # CORRECTED LINE: The 'if' condition now has the required ${{ ... }} syntax.
        if: ${{ secrets.SLACK_WEBHOOK != '' }}
        uses: 8398a7/action-slack@v3
        with:
          status: success
          custom_payload: |
            {
              "text": "ğŸ’¾ Database Backup for *${{ github.event.inputs.environment }}* Environment",
              "attachments": [
                {
                  "color": "#36a64f",
                  "fields": [
                    {
                      "title": "Status",
                      "value": "âœ… Success",
                      "short": true
                    },
                    {
                      "title": "Environment",
                      "value": "${{ github.event.inputs.environment }}",
                      "short": true
                    },
                    {
                      "title": "Project ID",
                      "value": "${{ env.PROJECT_ID }}",
                      "short": true
                    },
                    {
                      "title": "Triggered By",
                      "value": "${{ github.actor }}",
                      "short": true
                    }
                  ]
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}
